<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spelling Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      overflow: hidden;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ce79);
      background-size: 400%;
      animation: colorShift 15s ease infinite;
    }
    @keyframes colorShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    #game-container {
      text-align: center;
      width: 100%;
      max-width: 800px;
      padding: 3vw;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #letter-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 2.5vw;
      margin: 3vh auto;
      width: 100%;
      max-width: 600px;
    }
    #word-area {
      display: flex;
      justify-content: center;
      gap: 1.5vw;
      margin: 2vh auto;
      min-height: 60px;
      flex-wrap: wrap;
      width: 100%;
      max-width: 600px;
    }
    .letter-btn, .word-letter {
      padding: 2.5vw;
      font-size: clamp(16px, 4vw, 20px);
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      min-height: 60px;
      touch-action: none;
      box-sizing: border-box;
    }
    .letter-btn {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .letter-btn:hover:not(:disabled) {
      background-color: #45a049;
    }
    .letter-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .letter-btn.shake {
      animation: shake 0.5s ease;
    }
    .letter-btn.blink {
      animation: blink 1s ease infinite;
    }
    .word-letter {
      background-color: #008CBA;
      transition: background-color 0.2s ease;
    }
    .word-letter.highlight {
      background-color: #FFFF00;
      color: #000;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    @keyframes blink {
      0%, 100% { background-color: #4CAF50; }
      50% { background-color: #FFD700; }
    }
    #message {
      font-size: clamp(18px, 4vw, 22px);
      margin: 3vh 0;
      color: #333;
      word-wrap: break-word;
      width: 100%;
    }
    #score {
      font-size: clamp(14px, 3.5vw, 18px);
      margin: 1vh 0;
      color: #333;
    }
    #start-btn, #listen-btn, #pause-btn, #restart-btn {
      padding: 2.5vw 5vw;
      font-size: clamp(14px, 3.5vw, 18px);
      cursor: pointer;
      background-color: #008CBA;
      color: white;
      border: none;
      border-radius: 8px;
      margin: 1.5vh 1vw;
      min-height: 50px;
      touch-action: none;
    }
    #start-btn:hover, #listen-btn:hover, #pause-btn:hover, #restart-btn:hover {
      background-color: #006d93;
    }
    canvas {
      max-width: 100%;
      height: auto !important;
      margin: 0 auto;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 0;
    }
    @media (max-width: 600px) {
      #game-container {
        padding: 4vw;
      }
      #letter-buttons, #word-area {
        grid-template-columns: repeat(auto-fit, minmax(55px, 1fr));
        gap: 2vw;
        max-width: 90%;
      }
      .letter-btn, .word-letter {
        padding: 3vw;
        min-height: 55px;
        font-size: clamp(14px, 4.5vw, 18px);
      }
      #start-btn, #listen-btn, #pause-btn, #restart-btn {
        padding: 3vw 4vw;
        min-height: 55px;
        font-size: clamp(12px, 4vw, 16px);
      }
      #message {
        font-size: clamp(16px, 4.5vw, 20px);
      }
      #score {
        font-size: clamp(12px, 4vw, 16px);
      }
    }
    @media (orientation: landscape) and (max-height: 500px) {
      #game-container {
        padding: 2vh;
      }
      #letter-buttons, #word-area {
        gap: 1.5vw;
        max-width: 95%;
      }
      .letter-btn, .word-letter {
        padding: 2vw;
        min-height: 50px;
        font-size: clamp(12px, 3.5vw, 16px);
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="button-area">
      <button id="start-btn" onclick="startGame()">Start Game</button>
      <button id="listen-btn" onclick="spellOnce()" style="display: none;">Listen Again</button>
      <button id="pause-btn" onclick="pauseSpeech()" style="display: none;">Pause</button>
      <button id="restart-btn" onclick="restartGame()">Play Again</button>
    </div>
    <div id="score">Words completed: 0/50</div>
    <div id="word-area"></div>
    <div id="letter-buttons"></div>
    <div id="message"></div>
  </div>
<script>
let words = [
  {en: "dog", vi: "chÃ³", emoji: "ðŸ¶"},
  {en: "house", vi: "nhÃ ", emoji: "ðŸ "},
  {en: "laptop", vi: "mÃ¡y tÃ­nh xÃ¡ch tay", emoji: "ðŸ’»"},
  {en: "bicycle", vi: "xe Ä‘áº¡p", emoji: "ðŸš²"},
  {en: "brother", vi: "anh trai", emoji: "ðŸ‘¨"},
  {en: "idea", vi: "Ã½ tÆ°á»Ÿng", emoji: "ðŸ’¡"},
  {en: "book", vi: "sÃ¡ch", emoji: "ðŸ“š"},
  {en: "test", vi: "bÃ i kiá»ƒm tra", emoji: "ðŸ“"},
  {en: "friend", vi: "báº¡n bÃ¨", emoji: "ðŸ‘¥"},
  {en: "homework", vi: "bÃ i táº­p vá» nhÃ ", emoji: "ðŸ“–"},
  {en: "pen", vi: "bÃºt", emoji: "âœï¸"},
  {en: "bag", vi: "tÃºi", emoji: "ðŸŽ’"},
  {en: "garden", vi: "vÆ°á»n", emoji: "ðŸŒ±"},
  {en: "phone", vi: "Ä‘iá»‡n thoáº¡i", emoji: "ðŸ“±"},
  {en: "sister", vi: "chá»‹/em gÃ¡i", emoji: "ðŸ‘©"},
  {en: "teacher", vi: "giÃ¡o viÃªn", emoji: "ðŸ‘©â€ðŸ«"},
  {en: "flower", vi: "hoa", emoji: "ðŸŒ¸"},
  {en: "holiday", vi: "ká»³ nghá»‰", emoji: "ðŸŒ´"},
  {en: "watch", vi: "Ä‘á»“ng há»“", emoji: "âŒš"},
  {en: "story", vi: "cÃ¢u chuyá»‡n", emoji: "ðŸ“œ"},
  {en: "friends", vi: "nhá»¯ng ngÆ°á»i báº¡n", emoji: "ðŸ‘¥"},
  {en: "puppy", vi: "chÃ³ con", emoji: "ðŸ•"},
  {en: "dream", vi: "giáº¥c mÆ¡", emoji: "ðŸ’­"},
  {en: "cake", vi: "bÃ¡nh ngá»t", emoji: "ðŸŽ‚"},
  {en: "trousers", vi: "quáº§n dÃ i", emoji: "ðŸ‘–"},
  {en: "jacket", vi: "Ã¡o khoÃ¡c", emoji: "ðŸ§¥"},
  {en: "big", vi: "lá»›n", emoji: "ðŸ“"},
  {en: "new", vi: "má»›i", emoji: "âœ¨"},
  {en: "red", vi: "Ä‘á»", emoji: "ðŸ”´"},
  {en: "good", vi: "tá»‘t", emoji: "ðŸ‘"},
  {en: "fun", vi: "vui", emoji: "ðŸ˜„"},
  {en: "nice", vi: "Ä‘áº¹p", emoji: "ðŸŒŸ"},
  {en: "orange", vi: "cam", emoji: "ðŸŸ "},
  {en: "blue", vi: "xanh dÆ°Æ¡ng", emoji: "ðŸ”µ"},
  {en: "small", vi: "nhá»", emoji: "ðŸ“"},
  {en: "smart", vi: "thÃ´ng minh", emoji: "ðŸ§ "},
  {en: "old", vi: "cÅ©", emoji: "ðŸ•°ï¸"},
  {en: "little", vi: "nhá» bÃ©", emoji: "ðŸ‘¶"},
  {en: "beautiful", vi: "xinh Ä‘áº¹p", emoji: "ðŸŒº"},
  {en: "pretty", vi: "xinh xáº¯n", emoji: "ðŸ’–"},
  {en: "english", vi: "tiáº¿ng Anh", emoji: "ðŸ‡¬ðŸ‡§"},
  {en: "math", vi: "toÃ¡n há»c", emoji: "âž•"},
  {en: "black", vi: "Ä‘en", emoji: "âš«"},
  {en: "white", vi: "tráº¯ng", emoji: "âšª"},
  {en: "long", vi: "dÃ i", emoji: "ðŸ“"},
  {en: "funny", vi: "hÃ i hÆ°á»›c", emoji: "ðŸ˜‚"},
  {en: "many", vi: "nhiá»u", emoji: "ðŸ”¢"},
  {en: "cute", vi: "dá»… thÆ°Æ¡ng", emoji: "ðŸ¥°"},
  {en: "warm", vi: "áº¥m Ã¡p", emoji: "ðŸ”¥"},
  {en: "yummy", vi: "ngon", emoji: "ðŸ½ï¸"}
];
let totalWords = words.length;
let currentWord = "";
let currentVietnamese = "";
let currentEmoji = "";
let currentLetters = [];
let selectedLetters = [];
let displayedLetters = [];
let fireworks = [];
let synth;
let gameStarted = false;
let currentLetterIndex = 0;
let wordCount = 0;
let waitingForCorrectLetter = false;
let lastTouchTime = 0;
const touchDebounceMs = 100;
let voicesLoaded = false;

// Cache DOM elements
const gameContainer = document.getElementById('game-container');
const wordArea = document.getElementById('word-area');
const letterButtons = document.getElementById('letter-buttons');
const message = document.getElementById('message');
const score = document.getElementById('score');
const startBtn = document.getElementById('start-btn');
const listenBtn = document.getElementById('listen-btn');
const pauseBtn = document.getElementById('pause-btn');
const restartBtn = document.getElementById('restart-btn');

function setup() {
  let canvas = createCanvas(Math.min(windowWidth, 800), Math.min(windowHeight, 400));
  canvas.parent(gameContainer);
  canvas.style('touch-action', 'none');
  synth = window.speechSynthesis;
  // Preload voices and wait for them to load
  synth.onvoiceschanged = () => {
    voicesLoaded = true;
    console.log('Voices loaded:', synth.getVoices());
  };
  synth.getVoices();
  windowResized();
}

function windowResized() {
  resizeCanvas(Math.min(windowWidth, 800), Math.min(windowHeight, 400));
  let canvas = select('canvas');
  canvas.position(0, 0);
}

function getEnglishVoice() {
  const voices = synth.getVoices();
  const voice = voices.find(v => v.lang === 'en-US' || v.lang === 'en_US') || voices[0];
  console.log('Selected voice:', voice ? voice.name : 'none');
  return voice;
}

function startGame() {
  if (gameStarted || !voicesLoaded) {
    if (!voicesLoaded) console.log('Waiting for voices to load');
    return;
  }
  gameStarted = true;
  waitingForCorrectLetter = false;
  currentLetterIndex = 0;
  startBtn.style.display = 'none';
  listenBtn.style.display = 'inline-block';
  pauseBtn.style.display = 'inline-block';
  restartBtn.style.display = 'inline-block';
  let wordObj = words[Math.floor(Math.random() * words.length)];
  currentWord = wordObj.en;
  currentVietnamese = wordObj.vi;
  currentEmoji = wordObj.emoji;
  currentLetters = currentWord.toUpperCase().split('');
  selectedLetters = [];
  displayedLetters = [];
  fireworks = [];
  message.innerText = "Listen and click the letters!";
  wordArea.innerHTML = "";
  letterButtons.innerHTML = "";
  let uniqueLetters = [...new Set(currentWord.toUpperCase().split(''))];
  displayedLetters = shuffle(uniqueLetters);
  updateLetterButtons();
  setTimeout(spellNextLetter, 100);
}

function restartGame() {
  synth.cancel();
  wordCount = 0;
  gameStarted = false;
  waitingForCorrectLetter = false;
  score.innerText = `Words completed: 0/${totalWords}`;
  startBtn.style.display = 'inline-block';
  listenBtn.style.display = 'none';
  pauseBtn.style.display = 'none';
  restartBtn.style.display = 'inline-block';
  message.innerText = "";
  wordArea.innerHTML = "";
  letterButtons.innerHTML = "";
  fireworks = [];
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function spellNextLetter() {
  if (!gameStarted || waitingForCorrectLetter || currentLetterIndex >= currentLetters.length) {
    message.innerText = "Click the letters or press Listen Again!";
    return;
  }
  synth.cancel();
  let letter = currentLetters[currentLetterIndex];
  console.log(`Speaking letter: ${letter}, Index: ${currentLetterIndex}, Word: ${currentWord}`);
  let utterance = new SpeechSynthesisUtterance(letter);
  utterance.lang = 'en-US';
  utterance.voice = getEnglishVoice();
  utterance.volume = 1.0;
  utterance.rate = 0.8;
  utterance.onerror = (e) => {
    console.log(`Speech error in spellNextLetter: ${e.error}`);
    let fallback = new SpeechSynthesisUtterance(letter);
    fallback.lang = 'en-US';
    fallback.volume = 1.0;
    fallback.rate = 0.8;
    synth.speak(fallback);
  };
  synth.speak(utterance);
}

function spellOnce() {
  if (!gameStarted || waitingForCorrectLetter) return;
  setTimeout(spellNextLetter, 100);
}

function pauseSpeech() {
  if (!gameStarted) return;
  synth.cancel();
  waitingForCorrectLetter = false;
  updateButtonStates();
  message.innerText = "Paused. Press Listen Again to hear the word!";
}

function spellSuperQuickly(callback) {
  synth.cancel();
  const letterDivs = wordArea.getElementsByClassName('word-letter');
  let queue = currentLetters.slice(); // Copy letters to process
  let retries = 0;
  const maxRetries = 3;

  function speakNextLetter() {
    if (queue.length === 0) {
      callback();
      return;
    }
    synth.cancel(); // Clear queue before each utterance
    let letter = queue.shift();
    let index = currentLetters.length - queue.length - 1;
    console.log(`SuperQuickly speaking letter: ${letter}, Index: ${index}, Word: ${currentWord}`);
    let utterance = new SpeechSynthesisUtterance(letter);
    utterance.lang = 'en-US';
    utterance.voice = getEnglishVoice();
    utterance.volume = 1.0;
    utterance.rate = 2.5;
    utterance.onstart = () => {
      if (letterDivs[index]) {
        letterDivs[index].classList.add('highlight');
      }
    };
    utterance.onend = () => {
      if (letterDivs[index]) {
        letterDivs[index].classList.remove('highlight');
      }
      setTimeout(speakNextLetter, 100); // Increased delay for mobile
    };
    utterance.onerror = (e) => {
      console.log(`Speech error in spellSuperQuickly: ${e.error}, Letter: ${letter}, Index: ${index}`);
      if (retries < maxRetries) {
        retries++;
        queue.unshift(letter); // Retry the failed letter
        setTimeout(speakNextLetter, 100);
      } else {
        // Fallback: speak letters individually
        console.log('Falling back to individual letter speech');
        let fallback = new SpeechSynthesisUtterance(letter);
        fallback.lang = 'en-US';
        fallback.volume = 1.0;
        fallback.rate = 2.5;
        synth.speak(fallback);
        setTimeout(speakNextLetter, 100);
      }
    };
    synth.speak(utterance);
  }
  speakNextLetter();
}

function updateLetterButtons() {
  letterButtons.innerHTML = "";
  displayedLetters.forEach(letter => {
    let btn = document.createElement('button');
    btn.innerText = letter;
    btn.className = 'letter-btn';
    const handler = (e) => {
      if (e.type === 'touchstart' || e.type === 'touchend') {
        e.preventDefault();
        const now = Date.now();
        if (now - lastTouchTime < touchDebounceMs) return;
        lastTouchTime = now;
      }
      selectLetter(letter, btn);
    };
    btn.onclick = handler;
    btn.ontouchstart = handler;
    btn.ontouchend = handler;
    letterButtons.appendChild(btn);
  });
  updateButtonStates();
}

function updateButtonStates() {
  let buttons = letterButtons.getElementsByClassName('letter-btn');
  for (let btn of buttons) {
    btn.classList.remove('shake', 'blink');
    btn.disabled = waitingForCorrectLetter && btn.innerText !== currentLetters[currentLetterIndex];
    if (waitingForCorrectLetter && btn.innerText === currentLetters[currentLetterIndex]) {
      btn.classList.add('blink');
      btn.disabled = false;
    }
  }
}

function selectLetter(letter, button) {
  if (!gameStarted) return;
  let expectedLetter = currentLetters[currentLetterIndex];
  console.log(`Selected: ${letter}, Expected: ${expectedLetter}, Index: ${currentLetterIndex}, Waiting: ${waitingForCorrectLetter}, SelectedLetters: ${selectedLetters.join('')}, Word: ${currentWord}`);
  if (letter === expectedLetter) {
    waitingForCorrectLetter = false;
    selectedLetters.push(letter);
    let letterDiv = document.createElement('div');
    letterDiv.innerText = letter;
    letterDiv.className = 'word-letter';
    wordArea.appendChild(letterDiv);
    message.innerText = `Right word: ${selectedLetters.join('')}`;
    updateLetterButtons();
    if (selectedLetters.length === currentLetters.length) {
      wordCount++;
      score.innerText = `Words completed: ${wordCount}/${totalWords}`;
      gameStarted = false;
      spellSuperQuickly(() => {
        message.innerText = `Correct! "${currentWord}" means "${currentVietnamese}" in Vietnamese! ${currentEmoji}`;
        let utterance = new SpeechSynthesisUtterance(currentWord);
        utterance.lang = 'en-US';
        utterance.voice = getEnglishVoice();
        utterance.volume = 1.0;
        utterance.rate = 0.8;
        utterance.onerror = (e) => {
          console.log(`Speech error for final word: ${e.error}, Word: ${currentWord}`);
          let fallback = new SpeechSynthesisUtterance(currentWord);
          fallback.lang = 'en-US';
          fallback.volume = 1.0;
          fallback.rate = 0.8;
          synth.speak(fallback);
        };
        synth.speak(utterance);
        createFireworks();
        setTimeout(() => {
          message.innerText = "";
          startGame();
        }, 5000);
      });
    } else {
      currentLetterIndex++;
      setTimeout(spellNextLetter, 100);
    }
  } else {
    synth.cancel();
    waitingForCorrectLetter = true;
    button.classList.add('shake');
    setTimeout(() => button.classList.remove('shake'), 500);
    message.innerText = "Wrong letter! Try the blinking letter.";
    updateButtonStates();
  }
}

function checkAnswer() {
  if (!gameStarted) return;
  if (selectedLetters.join('') === currentLetters.join('')) {
    wordCount++;
    score.innerText = `Words completed: ${wordCount}/${totalWords}`;
    gameStarted = false;
    waitingForCorrectLetter = false;
    updateButtonStates();
    spellSuperQuickly(() => {
      message.innerText = `Correct! "${currentWord}" means "${currentVietnamese}" in Vietnamese! ${currentEmoji}`;
      let utterance = new SpeechSynthesisUtterance(currentWord);
      utterance.lang = 'en-US';
      utterance.voice = getEnglishVoice();
      utterance.volume = 1.0;
      utterance.rate = 0.8;
      utterance.onerror = (e) => {
        console.log(`Speech error for final word: ${e.error}, Word: ${currentWord}`);
        let fallback = new SpeechSynthesisUtterance(currentWord);
        fallback.lang = 'en-US';
        fallback.volume = 1.0;
        fallback.rate = 0.8;
        synth.speak(fallback);
      };
      synth.speak(utterance);
      createFireworks();
      setTimeout(() => {
        message.innerText = "";
        startGame();
      }, 5000);
    });
  }
}

function createFireworks() {
  let rect = wordArea.getBoundingClientRect();
  let canvasRect = document.getElementsByTagName('canvas')[0].getBoundingClientRect();
  let xCenter = rect.left + rect.width / 2 - canvasRect.left;
  let yCenter = rect.top + rect.height / 2 - canvasRect.top;
  for (let i = 0; i < 10; i++) {
    fireworks.push({
      x: xCenter,
      y: yCenter,
      vx: random(-5, 5),
      vy: random(-15, -5),
      color: color(random(255), random(255), random(255)),
      life: 50
    });
  }
}

function draw() {
  if (fireworks.length === 0) return;
  clear();
  for (let i = fireworks.length - 1; i >= 0; i--) {
    let f = fireworks[i];
    f.x += f.vx;
    f.y += f.vy;
    f.vy += 0.1;
    f.life--;
    if (f.life <= 0) {
      fireworks.splice(i, 1);
      continue;
    }
    fill(f.color);
    noStroke();
    ellipse(f.x, f.y, 5, 5);
  }
}
</script>
</body>
</html>
